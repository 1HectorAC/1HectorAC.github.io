<!DOCTYPE html>
<html lang="en">

<head>
    <meta cahrset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
        integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <link rel="stylesheet" href="../css/default.css">
    <title>Battery Charge Blog</title>
</head>

<body>
    <div class="title text-center">
        <h1><a href="../index.html">Programming Portfolio</a></h1>
        <h6><i>By Hector Acosta-Cervantes</i></h6>
    </div>
    <div class="blackBar">
        <a href="../index.html">Home</a> >
        <a href="../personalProjectsPage.html">Personal Projects (Web Development)</a> >
        Battery Charge Blog
    </div>
    <div class="container text-center">
        <div class="whitePanel">
            <h2><b>Battery Charge Blog</b></h2>
            <h4><i>ASP.NET Core MVC</i></h4>
        </div>
    </div>
    <div class="container">

        <div class="row">
            <div class="col-md-4">
                <div class="blackPanel">
                    <h4>Summary</h4>
                    <hr class="whiteLine" />
                    <p class="paragraphText">
                        This website is about tracking the charge of old device batteries to maintain their lifespan.
                        Users can
                        log in to add devices and see which devices need to be recharged. Link to the git hub
                        repositiory <a href="https://github.com/1HectorAC/BatteryCharge">here.</a>
                    </p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="blackPanel">
                    <h4>Goal</h4>
                    <hr class="whiteLine" />
                    <p class="paragraphText">The goal was to get more familiar with ASP.NET Core MVC web framework. I
                        have some experience
                        with ASP.NET MVC so most of my focus was on understanding some of the changes between the two.
                    </p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="blackPanel">
                    <h4>Tools</h4>
                    <hr class="whiteLine" />
                    <p class="paragraphText">
                        The main language I used was C#. ASP.NET Core MVC web framework was used and Visual Studio 2021
                        was my IDE. I also use SQL Server with SQL Management Studio.
                    </p>
                </div>
            </div>
            <div class="col-md-6 offset-md-3">
                <div class="blackPanel">
                    <h4>Table of Contents</h4>
                    <hr class="whiteLine" />
                    <ol>
                        <li><a href="#databaseSection">Database</a></li>
                        <li><a href="#setupSection">Setup</a></li>
                        <li><a href="#NPSection">Nuget Packages</a></li>
                        <li><a href="#connectStringSection">Connection String</a></li>
                        <li><a href="#generateMCSection">Generate Models & Context</a></li>
                        <li><a href="#editUserSection">Edit User Registration</a></li>
                        <li><a href="#scaffoldSection">Scaffolding Device CRUD</a></li>
                        <li><a href="#viewRestrictSection">Device View Restrictions</a></li>
                        <li><a href="#chargeTimeSection">ChargeTimes Page</a></li>
                        <li><a href="#finalSection">Final Thoughts</a></li>
                    </ol>
                </div>
            </div>
        </div>
        <div class="blackPanelWithMorePadding">
            <h4 id="databaseSection">1. Database</h4>
            <hr class="whiteLine" />
            <div class="row">
                <div class="col-md-6">
                    <p class="paragraphText">I used a database first approach so one of my first task was just setting
                        up a database. The
                        database was
                        pretty simple with just 2 table. The tables were BatteryTrackerUser and Device. I provided a
                        diagram of them. After that I used SQL management studio to make the
                        database.</p>
                </div>
                <div class="col-md-6">
                    <img class="formatedImage" src="images/BatteryTrackerDBDiagram.PNG" alt="">
                </div>
            </div>
            <br /><br />

            <h4 id="setupSection">2. Setup</h4>
            <hr class="whiteLine" />
            <p class="paragraphText">On visual studio I created a project with the template "ASP.NET core Web App
                (MVC)." I also set the
                Authentication type to "Individual Account."</p>
            <br /><br />

            <h4 id="NPSection">3. Nuget Packages</h4>
            <hr class="whiteLine" />
            <p class="paragraphText">The next step was to download all the necessary Nuget packages. With Visual Studio
                I can just select the
                "Nuget Packet Manager" option in the top "Tools" bar to add them. With the Nuget Packet Manager command
                prompt I can just run the following command to get what I need:</p>
            <pre class="codeBlockPanel"><code>
Install-Package Microsoft.EntityFrameworkCore.Tools
Install-Package Microsoft.EntityFrameworkCore.SqlServer
            </code></pre>
            <br /><br />

            <h4 id="connectStringSection">4. Connection String</h4>
            <hr class="whiteLine" />
            <p>Step to take for setting up connection string:</p>
            <ol class="text-start">
                <li>On Visual Studio open "Server Explorer" (Can be accessed from top panels.)</li>
                <li>Right click on "Data Connection."</li>
                <li>Add connection (choses "Microsoft SQL Server", enter Server name and database name.)</li>
                <li>Make sure to test connection before clicking enter.</li>
                <li>Add connection string to "appsettings.json" file. Make sure to set connection string name to
                    "BatteryDBConnection." You can also add to secret file instead. Instuction on how <a
                        href="https://www.sharepointcafe.net/2021/04/secret-manager-in-dotnet-core.html#:~:text=Secret%20Manager%20is%20a%20feature%20in%20ASP.Net%20Core,database%20password%20will%20not%20be%20shared%20with%20them.">here.</a>
                </li>
            </ol>
            <pre class="codeBlockPanel"><code>
// Example connection string code
"ConnectionStrings": {
    "DatabaseName": "Enter connection String here"
    }
            </code></pre>
            <br /><br />

            <h4 id="generateMCSection">5. Generate Models & Context</h4>
            <hr class="whiteLine" />
            <p class="paragraphText">I then generated the models and context class using the database. I first go to the
                "Package Manager
                Console" and enter the following command to generate what I need:</p>
            <pre class="codeBlockPanel"><code>
Scaffold-DbContext Name=BatteryDBConnection Microsoft.EntityFrameworkCore.SqlServer -Tables 
        BatteryTrackerUser, Device -OutputDir Models -ContextDir Models -Context BatteryContext
            </code></pre>
            <p class="paragraphText">This will generate 2 tables (BatteryTrackerUser and Device) and a model context
                (BatteryContext) in the
                Models folder.</p>
            <br /><br />

            <h4 id="editUserSection">6. Edit User Registration</h4>
            <hr class="whiteLine" />
            <p class="paragraphText">I have a separate user table called "BatteryTrackerUser" that will need to be
                created at the same time
                the user makes an account. My intention in doing this was to keep some of the auto generated user stuff
                separated from my application. Now since the auto generated user files are abstracted away I will need
                to generate the files I need first. Here the are step to do this:</p>
            <ol class="text-start">
                <li>Right click on project folder.</li>
                <li>Select "Add" option.</li>
                <li>Select "New Scaffolded Item" option.</li>
                <li>On the new panel, Select "Identity."</li>
                <li>Checkmark the "Register" page. I also added a few other to edit styling.</li>
                <li>Done. The register page is now generated.</li>
            </ol>
            <p class="paragraphText">I then needed to add the database context I created to the register page in
                order to have access
                to the "BatteryTrackerUser" table. A few things will need to be edited to make this work.
                I first went to the register.cs file (located in Areas/Identy/Pages/Account/Register file with
                the cs file being a dropdown from register.cshtml file.) I then Added the "BatteryContext" at
                the top of the page which is setup though Dependency Injection. This involves adding a private
                readonly BattteryContext variable, BatteryContext parameter to RegisterModels method, and set
                private BatteryContext variable to passed in parameter. Thirdly I removed some of the connection
                code in "BatteryContext" and move it to the Program.cs file. Section to remove and add shown
                shown here:</p>
            <pre class="codeBlockPanel"><code>
//Removed from BatteryContext.cs
 protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder) =&gt; 
        optionsBuilder.UseSqlServer("Name=BatteryDBConnection");

// Added to Program.cs File
var connectionString = builder.Configuration.GetConnectionString("BatteryDBConnection");
builder.Services.AddDbContext<BatteryContext>(options =&gt; options.UseSqlServer(connectionString));
builder.Services.AddDbContext<ApplicationDbContext>(options =&gt; options.UseSqlServer(connectionString));
builder.Services.AddDatabaseDeveloperPageExceptionFilter();
            </code></pre>
            <p class="paragraphText">Finally I created a "BatteryTrackerUser" in the register page. In the
                register page we go to the
                "OnPostAsync" method and before the email sender send an email we add the following:</p>
            <pre class="codeBlockPanel"><code>
// Create BatteryTrackerUser in Register.cs
var batteryTrackerUser = new BatteryTrackerUser { AspNetUserId = userId };
_batteryContext.BatteryTrackerUsers.Add(batteryTrackerUser);
await _batteryContext.SaveChangesAsync();
            </code></pre>
            <p class="paragraphText">With that the BatteryTrackerUser is created on register of a user.</p>
            <br /><br />

            <h4 id="scaffoldSection">7. Scaffolding Device CRUD</h4>
            <hr class="whiteLine" />
            <p>The next step is to scaffold CRUD pages for a device. Steps:</p>
            <ol class="text-start">
                <li>Right click on controller folder.</li>
                <li>Click on "Add" option.</li>
                <li>Click on "New Scaffolded Item" option.</li>
                <li>On new window, Select "MVC Controller with view, using EF."</li>
                <li>Enter the Data Context Class field with "BatteryContext" and the Model Class field with "Device."
                </li>
                <li>Done. CRUD pages should be generated.</li>
            </ol>
            <br /><br />

            <h4 id="viewRestrictSection">8. Device View Restrictions</h4>
            <hr class="whiteLine" />
            <p class="paragraphText">I then needed to make sure devices can only be handled by logged in users and that
                they cant access each
                others. I first restrict device page access to logged in users. This can be done by adding the Authorize
                attribute above every method involving a device. I then dealt with users restricted to just their own
                devices. To accomplish this I added a quick check in most device method to compare the id of the current
                user with the id owner of the device it is trying to access. It will then redirect if there is a
                mismatch. Example shown:</p>

            <pre class="codeBlockPanel"><code>
// User check in DevicesController.cs
var deviceUserId = _context.Devices.Include(d => d.Owner).First(i => i.Id == id).Owner!.AspNetUserId;
var loggedInUserId = User.FindFirstValue(ClaimTypes.NameIdentifier);
if (loggedInUserId != deviceUserId)
        return RedirectToAction(nameof(Index));
            </code></pre>
            <p class="paragraphText">Similar checks were also added to view and create devices but were a bit more
                simpler.</p>
            <br /><br />

            <h4 id="chargeTimeSection">9. ChargeTimes Page</h4>
            <hr class="whiteLine" />
            <p class="paragraphText">The last main feature is the "ChargeTimes" page. This is a page that will inform
                the user about if a
                device they own needs to be recharged. The page displays the days since the last charge (current date -
                last charge date) as well as the time span the battery can last without charge (Note: last charge date
                and charge time span are both fields for a device). It will also color coat the text red if the days
                since last charge is larger than the time span.</p>
            <p class="paragraphText">The first part is to setup a view model for the necessary data since I don’t need
                all the data of a
                device and I will also need another field for days since last change(which isn't in the Device Model.)
                Steps:</p>
            <ol class="text-start">
                <li>Create Models/VIewModels folder.</li>
                <li>Create RechargeDeviceDetails.cs file in ViewModel folder.</li>
                <li>Add Id, Name, LastRechargeDate, RechargeCycle To RechargeDeviceDetails Model (Note: Fields are
                    identical to the Device Model.)</li>
                <li>Add integer DaysSinceLastRecharge field to RechargeDeviceDetails Model.</li>
                <li>Model done.</li>
            </ol>
            <p class="paragraphText">Now that I have the ViewModel done I can setup the ChargeTimes page. I began by
                copying the layout of the
                index page in the DeviceController. The Device index page and the ChargeTimes page are similar in that
                they both display a list of a model type. The big difference is setting up the data for the
                RechargeDeviceDetails model in ChargeTimes. This is done with a Linq query where most of the values are
                passed by a device and the days since last charge is calcualted. Example of this code:</p>
            <pre class="codeBlockPanel"><code>
// Section of ChargeTimes method in DevicesController
var currentDateDays = DateOnly.FromDateTime(DateTime.Today).DayNumber;

var batteryChargeDetails = batteryContext.Select(
    i =&gt; new RechargeDeviceDetails {
        Id = i.Id, Name = i.Name, 
        LastRechargeDate = i.LastRechargeDate, 
        RechargeCycle = i.RechargeCycle, 
        DaysSinceLastRecharge = currentDateDays - DateOnly.FromDateTime(i.LastRechargeDate).DayNumber });
            </code></pre>
            <p class="paragraphText">I also wanted to briefly show how the text becomes colored red when it needs a
                charge. This one is just a
                simple if statement that will add a class that color coats the text if added. Example:</p>
            <pre class="codeBlockPanel"><code>
// Section in ChargeTimes.cshtml
&lt;h2 class="@(item.DaysSinceLastRecharge &gt;= item.RechargeCycle ? "alertText" : "" )"&gt;
    @item.DaysSinceLastRecharge / @item.RechargeCycle days
&lt;/h2&gt;
            </code></pre>
            <br /><br />

            <h4 id="finalSection">10. Final Thoughts</h4>
            <hr class="whiteLine" />
            <p class="paragraphText">My previously experience with ASP.Net MVC has really made using ASP.Net Core MVC a
                lot easier. Many of
                the concepts were the same but a lot of how to set things up has changed. For example, some of the
                scaffolding has become more command line oriented to use, when you use the auto generated account stuff
                the files aren't there by default, configuration setting have moved files, and etc. I wanted to also
                mention that a lot of the changes weren't intuitive to figure out and required me to look up various
                tutorials to solve. This definitely cost me a good amount of time to figure out but I think most of the
                changes kind of made sense. Like abstracting away the auto generated user account files does make the
                files cleaner when you don’t have a lot you won't really edit. Using dependency injection by default was
                also pretty cool given that it will also make testing easier in the future. I also feel like you have
                more control with the command line approach in scaffolding models and context.</p>
        </div>
    </div>
</body>

</html>